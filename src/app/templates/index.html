{% extends "base.html" %}

{% block title %}Cocktail Cache - AI-Powered Drink Recommendations{% endblock %}

{% block body_class %}page-chat{% endblock %}
{% block layout_class %}h-full flex flex-col{% endblock %}
{% block head_extra %}
<style>
    /* Ensure chat interface fills the dynamic viewport height */
    .chat-interface-container {
        height: 100%;
        max-height: var(--app-height, 100vh);
        max-height: 100dvh;
    }
</style>
{% endblock %}
{% block main_class %}flex-1 flex flex-col min-h-0{% endblock %}
{% block footer %}{% endblock %}{# No footer on chat interface #}

{% block content %}
{# Define cabinet content #}
{% set cabinet_content %}
<div class="p-4 space-y-4">
    <!-- Cabinet Summary -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold text-amber-200">Your Cabinet</h2>
            <p class="text-xs text-stone-400" id="cabinet-summary">Add ingredients you have at home</p>
        </div>
        <button id="panel-clear-cabinet" class="hidden btn btn-sm glass-btn-ghost text-xs gap-1">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Clear
        </button>
    </div>

    <!-- Selected Ingredients Display -->
    <div id="selected-ingredients" class="hidden">
        <div class="flex flex-wrap gap-1.5" id="selected-ingredients-list"></div>
    </div>

    <!-- Search/Add Input -->
    <div class="relative">
        <input type="text" id="panel-ingredient-search"
               class="glass-input w-full text-sm py-2.5 pl-9"
               placeholder="Search or add ingredients..."
               autocomplete="off">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <div id="panel-autocomplete" class="autocomplete-dropdown hidden"></div>
    </div>

    <!-- Category Grid -->
    <div id="panel-categories" class="space-y-2">
        <!-- Categories will be rendered here -->
    </div>

    <!-- Action Button -->
    <div class="sticky bottom-0 pt-3 bg-gradient-to-t from-stone-950/80 to-transparent">
        <button id="panel-continue-btn" class="btn glass-btn-primary w-full" disabled>
            Continue to Chat
        </button>
    </div>
</div>
{% endset %}

{# Define browse content with loading state #}
{% set browse_content %}
<div id="browse-panel-content" class="p-4 flex flex-col items-center justify-center min-h-[200px]">
    <div class="loading-spinner mb-3">
        <svg class="animate-spin h-8 w-8 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
    <p class="text-stone-400 text-sm">Loading drinks...</p>
</div>
{% endset %}

{# Define suggest content with loading state #}
{% set suggest_content %}
<div id="suggest-panel-content" class="p-4 flex flex-col items-center justify-center min-h-[200px]">
    <div class="loading-spinner mb-3">
        <svg class="animate-spin h-8 w-8 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
    <p class="text-stone-400 text-sm">Loading recommendations...</p>
</div>
{% endset %}

{% include "partials/chat-container.html" %}

<!-- Message Templates -->
<template id="bot-message-template">
    <div class="flex gap-2 sm:gap-3 animate-fade-in">
        <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <div class="flex-1 glass-message-bot rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-3 max-w-[88%]">
            <p class="text-stone-200 text-sm sm:text-base message-text"></p>
        </div>
    </div>
</template>

<template id="user-message-template">
    <div class="flex gap-2 justify-end animate-fade-in">
        <div class="glass-message-user rounded-2xl rounded-tr-sm px-3 py-2 sm:px-4 sm:py-3 max-w-[88%]">
            <p class="text-white text-sm sm:text-base message-text"></p>
        </div>
    </div>
</template>

<template id="recipe-card-template">
    <div class="flex gap-2 sm:gap-3 animate-fade-in">
        <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <div class="flex-1 min-w-0">
            <div class="glass-card-accent p-4 space-y-3">
                <!-- Recipe Header -->
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1">
                        <h3 class="text-lg sm:text-xl font-bold text-amber-300" id="recipe-name">-</h3>
                        <p class="text-stone-400 text-xs sm:text-sm mt-0.5 line-clamp-2" id="recipe-tagline">-</p>
                    </div>
                    <div class="match-score px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-semibold flex-shrink-0" id="recipe-score">
                        --%
                    </div>
                </div>

                <!-- Why this drink (collapsible) -->
                <div class="collapsible-section" id="recipe-why-section">
                    <button type="button" class="collapsible-trigger w-full text-left flex items-center justify-between py-1">
                        <span class="text-amber-400/80 text-xs uppercase tracking-wider font-medium">Why this drink</span>
                        <svg class="w-4 h-4 text-amber-400/60 transform transition-transform collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="collapsible-content">
                        <div class="glass-highlight rounded-lg p-2.5 mt-1">
                            <p class="text-stone-300 text-sm italic" id="recipe-why"></p>
                        </div>
                    </div>
                </div>

                <!-- Ingredients (collapsible, open by default) -->
                <div class="collapsible-section open">
                    <button type="button" class="collapsible-trigger w-full text-left flex items-center justify-between py-1">
                        <span class="text-amber-400 text-xs uppercase tracking-wider font-medium flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Ingredients
                        </span>
                        <svg class="w-4 h-4 text-amber-400/60 transform transition-transform rotate-180 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="collapsible-content open">
                        <ul id="recipe-ingredients" class="space-y-1 mt-2 text-sm"></ul>
                    </div>
                </div>

                <!-- Method (collapsible) -->
                <div class="collapsible-section">
                    <button type="button" class="collapsible-trigger w-full text-left flex items-center justify-between py-1">
                        <span class="text-amber-400/80 text-xs uppercase tracking-wider font-medium flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Method
                        </span>
                        <svg class="w-4 h-4 text-amber-400/60 transform transition-transform collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="collapsible-content">
                        <ol id="recipe-steps" class="space-y-2 mt-2 text-sm"></ol>
                    </div>
                </div>

                <!-- Details row (collapsible) -->
                <div class="collapsible-section" id="recipe-details-section">
                    <button type="button" class="collapsible-trigger w-full text-left flex items-center justify-between py-1">
                        <span class="text-amber-400/80 text-xs uppercase tracking-wider font-medium">Details</span>
                        <svg class="w-4 h-4 text-amber-400/60 transform transition-transform collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="collapsible-content">
                        <div class="flex flex-wrap gap-3 text-xs sm:text-sm mt-2">
                            <div id="recipe-glass-section" class="hidden">
                                <span class="text-stone-500">Glass:</span>
                                <span class="text-stone-300 ml-1" id="recipe-glass"></span>
                            </div>
                            <div id="recipe-garnish-section" class="hidden">
                                <span class="text-stone-500">Garnish:</span>
                                <span class="text-stone-300 ml-1" id="recipe-garnish"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 pt-2">
                    <button id="made-it-btn" class="btn btn-sm sm:btn-md glass-btn-success flex-1 gap-1 sm:gap-2 text-xs sm:text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="hidden xs:inline">I Made This!</span>
                        <span class="xs:hidden">Made it!</span>
                    </button>
                    <button id="another-btn" class="btn btn-sm sm:btn-md glass-btn-secondary flex-1 gap-1 sm:gap-2 text-xs sm:text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Another
                    </button>
                </div>
            </div>

            <!-- Next Bottle Recommendation -->
            <div id="bottle-rec" class="mt-2 glass-card bottle-card p-3 hidden">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-amber-900/50 flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-stone-400 text-xs">Next bottle to buy</p>
                        <p class="text-amber-300 font-medium text-sm sm:text-base" id="bottle-name">-</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-amber-400 font-bold text-sm sm:text-base" id="bottle-unlocks">+0</p>
                        <p class="text-stone-500 text-xs">drinks</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/cabinet-state.js') }}"></script>
<script src="{{ url_for('static', path='js/tab-manager.js') }}"></script>
<script src="{{ url_for('static', path='js/browse-panel.js') }}"></script>
<script src="{{ url_for('static', path='js/suggest-panel.js') }}"></script>
<script>
// Chat state
const state = {
    step: 'welcome',
    sessionId: null,
    chatSessionId: null,
    cabinet: [],
    mood: '',
    skillLevel: 'intermediate',
    drinkType: 'both',
    activeTab: 'chat'
};

// DOM elements
const chatMessages = document.getElementById('chat-messages');
const inputArea = document.getElementById('input-area');
const resetBtn = document.getElementById('reset-btn');
const cabinetCount = document.getElementById('cabinet-count');

// Panel elements (new structure)
const panelChat = document.getElementById('panel-chat');
const panelCabinet = document.getElementById('panel-cabinet');
const panelBrowse = document.getElementById('panel-browse');
const panelSuggest = document.getElementById('panel-suggest');

// Ingredients will be loaded from API (single source of truth)
let ingredients = {};
let ingredientsLoaded = false;

// Track if browse/suggest panels have been loaded
let browsePanelLoaded = false;
let suggestPanelLoaded = false;

// Load ingredients from API
async function loadIngredients() {
    if (ingredientsLoaded) return;
    try {
        const response = await fetch('/api/ingredients');
        const data = await response.json();
        ingredients = data.categories;
        ingredientsLoaded = true;
    } catch (error) {
        console.error('Failed to load ingredients:', error);
        // Fallback to empty - will show error in UI
        ingredients = {};
    }
}

// Fun mixology facts to display during loading
const mixologyFacts = [
    "The word 'cocktail' first appeared in print in 1806",
    "Ice wasn't commonly used in drinks until the 1830s",
    "Citrus was originally added to prevent scurvy on ships",
    "The Old Fashioned is considered the original cocktail",
    "Tiki drinks were invented in 1930s Hollywood",
    "The Martini may have originated during the Gold Rush",
    "Champagne bubbles were once considered a flaw",
    "Mint juleps date back to the 1700s",
    "Orange bitters were more popular than Angostura in the 1800s",
    "Bourbon must be aged in new charred oak barrels",
    "James Bond's 'shaken not stirred' actually bruises the gin",
    "The Margarita is the most ordered cocktail in the US",
    "Blue Curacao gets its color from food dye, not the fruit",
    "A 'neat' pour means no ice, no water, just spirit",
    "The Daiquiri was named after a Cuban mining town",
    "The Pina Colada is Puerto Rico's national drink",
    "Whiskey and whisky are both correct spellings",
    "The Gibson is just a Martini with an onion",
    "Shaking a cocktail adds more dilution than stirring",
    "The Negroni was invented by an Italian count in 1919"
];

let factInterval = null;

// Initialize chat
async function init() {
    resetBtn.addEventListener('click', resetChat);
    // Load ingredients from API before showing UI
    await loadIngredients();
    // Restore cabinet from localStorage if available
    const savedCabinet = loadCabinet();
    if (savedCabinet.length > 0) {
        state.cabinet = savedCabinet;
    }
    // Listen for tab changes from TabManager
    window.addEventListener('tab-changed', handleTabChange);
    // Update cabinet count badge
    updateCabinetCount();
    showWelcome();
}

// Handle tab changes from TabManager
function handleTabChange(event) {
    const { tab, previousTab } = event.detail;
    state.activeTab = tab;

    // Render cabinet when switching to cabinet tab
    if (tab === 'cabinet') {
        renderCabinetPanel();
    }

    // Load browse panel content on first visit
    if (tab === 'browse' && !browsePanelLoaded) {
        loadBrowsePanel();
    }

    // Load suggest panel content on first visit
    if (tab === 'suggest' && !suggestPanelLoaded) {
        loadSuggestPanel();
    }
}

// Load browse panel content
async function loadBrowsePanel() {
    const browseContent = document.getElementById('browse-panel-content');
    if (!browseContent) return;

    try {
        // For now, show a placeholder - this will be replaced with actual browse functionality
        browseContent.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-600/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-amber-200 mb-2">Browse Drinks</h3>
                <p class="text-stone-400 text-sm mb-4">Explore our collection of cocktails and mocktails</p>
                <a href="/browse" class="btn glass-btn-primary">
                    Open Full Browser
                </a>
            </div>
        `;
        browsePanelLoaded = true;
    } catch (error) {
        console.error('Failed to load browse panel:', error);
        browseContent.innerHTML = `
            <div class="text-center py-8 text-stone-400">
                <p>Failed to load drinks. Please try again.</p>
            </div>
        `;
    }
}

// Load suggest panel content
async function loadSuggestPanel() {
    const suggestContent = document.getElementById('suggest-panel-content');
    if (!suggestContent) return;

    try {
        // For now, show a placeholder - this will be replaced with actual suggest functionality
        suggestContent.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-600/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-amber-200 mb-2">Get Suggestions</h3>
                <p class="text-stone-400 text-sm mb-4">Let Raja recommend drinks based on your cabinet</p>
                <button id="get-suggestions-btn" class="btn glass-btn-primary" ${state.cabinet.length === 0 ? 'disabled' : ''}>
                    ${state.cabinet.length > 0 ? 'Get Recommendations' : 'Add ingredients first'}
                </button>
            </div>
        `;
        suggestPanelLoaded = true;

        // Add click handler for suggestions button
        const suggestBtn = document.getElementById('get-suggestions-btn');
        if (suggestBtn && state.cabinet.length > 0) {
            suggestBtn.addEventListener('click', () => {
                // Switch to chat tab and start the flow
                if (window.TabManager) {
                    window.TabManager.switchTo('chat');
                }
                onCabinetDone();
            });
        }
    } catch (error) {
        console.error('Failed to load suggest panel:', error);
        suggestContent.innerHTML = `
            <div class="text-center py-8 text-stone-400">
                <p>Failed to load suggestions. Please try again.</p>
            </div>
        `;
    }
}

function updateCabinetCount() {
    if (state.cabinet.length > 0) {
        cabinetCount.textContent = state.cabinet.length;
        cabinetCount.classList.remove('hidden');
    } else {
        cabinetCount.classList.add('hidden');
    }
    // Also update the nav badge
    window.dispatchEvent(new CustomEvent('cabinet-updated'));

    // Reset suggest panel when cabinet changes (to update button state)
    suggestPanelLoaded = false;
}

function renderCabinetPanel() {
    const categoriesContainer = document.getElementById('panel-categories');
    const selectedContainer = document.getElementById('selected-ingredients');
    const selectedList = document.getElementById('selected-ingredients-list');
    const clearBtn = document.getElementById('panel-clear-cabinet');
    const continueBtn = document.getElementById('panel-continue-btn');
    const summaryEl = document.getElementById('cabinet-summary');

    // Update summary
    if (state.cabinet.length > 0) {
        summaryEl.textContent = `${state.cabinet.length} ingredient${state.cabinet.length !== 1 ? 's' : ''} selected`;
        clearBtn.classList.remove('hidden');
        selectedContainer.classList.remove('hidden');
        continueBtn.disabled = false;
        continueBtn.textContent = `Continue with ${state.cabinet.length} ingredient${state.cabinet.length !== 1 ? 's' : ''}`;
    } else {
        summaryEl.textContent = 'Add ingredients you have at home';
        clearBtn.classList.add('hidden');
        selectedContainer.classList.add('hidden');
        continueBtn.disabled = true;
        continueBtn.textContent = 'Continue to Chat';
    }

    // Render selected ingredients
    selectedList.innerHTML = state.cabinet.map(id => {
        const item = findIngredientById(id);
        const name = item ? item.name : id.charAt(0).toUpperCase() + id.slice(1);
        const emoji = item ? item.emoji : '';
        return `
            <span class="glass-chip active bg-amber-600/30 border-amber-500/50 text-amber-200 px-2.5 py-1 rounded-full text-xs flex items-center gap-1.5">
                <span>${emoji}</span>${name}
                <button type="button" data-remove="${id}" class="hover:text-white transition-colors ml-0.5">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </span>
        `;
    }).join('');

    // Add remove handlers
    selectedList.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
            removeFromCabinet(btn.dataset.remove);
            renderCabinetPanel();
        });
    });

    // Render categories - first category starts expanded
    categoriesContainer.innerHTML = Object.entries(ingredients).map(([category, items], index) => `
        <div class="ingredient-category ${index === 0 ? 'open' : ''}">
            <button type="button" class="category-trigger w-full text-left flex items-center justify-between py-2 px-3 rounded-lg hover:bg-amber-900/20 transition-colors">
                <span class="text-stone-300 text-sm font-medium">${category}</span>
                <div class="flex items-center gap-2">
                    <span class="text-stone-500 text-xs">${items.filter(i => state.cabinet.includes(i.id)).length}/${items.length}</span>
                    <svg class="w-4 h-4 text-stone-500 transform transition-transform category-icon ${index === 0 ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            <div class="category-content ${index === 0 ? 'open' : ''}">
                <div class="flex flex-wrap gap-1.5 pt-2 pb-1 px-1">
                    ${items.map(item => `
                        <button type="button"
                                data-id="${item.id}"
                                class="panel-ingredient-chip glass-chip px-2.5 py-1 rounded-full text-xs transition-all
                                       hover:bg-amber-600/20 hover:border-amber-500/40
                                       ${state.cabinet.includes(item.id) ? 'active bg-amber-600/30 border-amber-500/50 text-amber-200' : 'text-stone-300'}">
                            <span class="mr-0.5">${item.emoji}</span>${item.name}
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');

    // Category toggle handlers
    categoriesContainer.querySelectorAll('.category-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
            const category = trigger.closest('.ingredient-category');
            const content = category.querySelector('.category-content');
            const icon = trigger.querySelector('.category-icon');
            category.classList.toggle('open');
            content.classList.toggle('open');
            icon.classList.toggle('rotate-180');
        });
    });

    // Ingredient chip handlers
    categoriesContainer.querySelectorAll('.panel-ingredient-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const id = chip.dataset.id;
            if (state.cabinet.includes(id)) {
                removeFromCabinet(id);
            } else {
                addToCabinet(id);
            }
            renderCabinetPanel();
        });
    });

    // Clear button handler
    clearBtn.onclick = () => {
        state.cabinet = [];
        clearCabinet();
        updateCabinetCount();
        renderCabinetPanel();
    };

    // Continue button handler
    continueBtn.onclick = () => {
        if (window.TabManager) {
            window.TabManager.switchTo('chat');
        }
        // If we're at welcome/cabinet/quickstart step and have ingredients, advance the conversation
        if (state.step === 'cabinet' || state.step === 'welcome' || state.step === 'quickstart') {
            // Clear old messages and refresh with current cabinet count
            chatMessages.innerHTML = '';
            addBotMessage("Arrey yaar, welcome! Raja here - let's go, ready to make some drinks. âš ï¸ Quick note: I'm an AI, so verify recipes before mixing!");
            setTimeout(() => {
                addBotMessage(`${state.cabinet.length} bottle${state.cabinet.length !== 1 ? 's' : ''} in your cabinet. So, what's the mood - ready to mix or just chatting?`);
                showQuickStartInput();
            }, 300);
        }
    };

    // Setup search/autocomplete
    setupPanelSearch();
}

function findIngredientById(id) {
    for (const items of Object.values(ingredients)) {
        const found = items.find(i => i.id === id);
        if (found) return found;
    }
    return null;
}

function addToCabinet(id) {
    if (!state.cabinet.includes(id)) {
        state.cabinet.push(id);
        saveCabinet(state.cabinet);
        updateCabinetCount();
    }
}

function removeFromCabinet(id) {
    state.cabinet = state.cabinet.filter(i => i !== id);
    saveCabinet(state.cabinet);
    updateCabinetCount();
}

function setupPanelSearch() {
    const searchInput = document.getElementById('panel-ingredient-search');
    const dropdown = document.getElementById('panel-autocomplete');
    let selectedIndex = -1;

    function getAllIngredients() {
        const allItems = [];
        for (const [category, items] of Object.entries(ingredients)) {
            for (const item of items) {
                allItems.push({ ...item, category });
            }
        }
        return allItems;
    }

    function filterIngredients(query) {
        if (!query || query.length < 2) return [];
        const lowerQuery = query.toLowerCase();
        return getAllIngredients()
            .filter(item => item.name.toLowerCase().includes(lowerQuery) && !state.cabinet.includes(item.id))
            .slice(0, 6);
    }

    function renderDropdown(matches) {
        if (matches.length === 0) {
            dropdown.classList.add('hidden');
            return;
        }
        dropdown.innerHTML = matches.map((item, index) => `
            <div class="autocomplete-item ${index === selectedIndex ? 'selected' : ''}"
                 data-id="${item.id}" data-index="${index}">
                <span class="autocomplete-emoji">${item.emoji}</span>
                <span class="autocomplete-name">${item.name}</span>
                <span class="autocomplete-category">${item.category}</span>
            </div>
        `).join('');
        dropdown.classList.remove('hidden');

        dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
                addToCabinet(item.dataset.id);
                searchInput.value = '';
                dropdown.classList.add('hidden');
                renderCabinetPanel();
            });
        });
    }

    searchInput.addEventListener('input', (e) => {
        const matches = filterIngredients(e.target.value.trim());
        selectedIndex = -1;
        renderDropdown(matches);
    });

    searchInput.addEventListener('keydown', (e) => {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            renderDropdown(filterIngredients(searchInput.value.trim()));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            renderDropdown(filterIngredients(searchInput.value.trim()));
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            const item = items[selectedIndex];
            if (item) {
                addToCabinet(item.dataset.id);
                searchInput.value = '';
                dropdown.classList.add('hidden');
                renderCabinetPanel();
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.add('hidden');
        }
    });
}

function resetChat(clearSavedCabinet = false) {
    state.step = 'welcome';
    state.sessionId = null;
    state.chatSessionId = null;
    if (clearSavedCabinet) {
        state.cabinet = [];
        clearCabinet();
    }
    // Keep cabinet but reset other preferences
    state.mood = '';
    state.skillLevel = 'intermediate';
    state.drinkType = 'both';
    chatMessages.innerHTML = '';
    showWelcome();
}

function scrollToBottom() {
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

function addBotMessage(text) {
    const template = document.getElementById('bot-message-template');
    const clone = template.content.cloneNode(true);
    clone.querySelector('.message-text').textContent = text;
    chatMessages.appendChild(clone);
    scrollToBottom();
}

function addUserMessage(text) {
    const template = document.getElementById('user-message-template');
    const clone = template.content.cloneNode(true);
    clone.querySelector('.message-text').textContent = text;
    chatMessages.appendChild(clone);
    scrollToBottom();
}

function addTypingIndicator() {
    const div = document.createElement('div');
    div.id = 'typing-indicator';
    div.className = 'flex gap-2 sm:gap-3 animate-fade-in';
    div.innerHTML = `
        <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <div class="glass-message-bot rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-3">
            <div class="flex gap-1">
                <span class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                <span class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                <span class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
            </div>
        </div>
    `;
    chatMessages.appendChild(div);
    scrollToBottom();
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
}

// Collapsible sections handler
function initCollapsibles(container) {
    container.querySelectorAll('.collapsible-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
            const section = trigger.closest('.collapsible-section');
            const content = section.querySelector('.collapsible-content');
            const icon = trigger.querySelector('.collapsible-icon');

            section.classList.toggle('open');
            content.classList.toggle('open');
            icon.classList.toggle('rotate-180');
        });
    });
}

// Raja Chat Functions
function showChatInput() {
    inputArea.innerHTML = `
        <div class="flex gap-2">
            <input type="text" id="chat-input"
                   class="glass-input flex-1 text-sm py-2.5"
                   placeholder="Ask Raja anything about cocktails..."
                   autocomplete="off">
            <button id="chat-send-btn" class="btn glass-btn-primary px-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    `;

    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');

    sendBtn.addEventListener('click', sendChatMessage);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    });

    input.focus();
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.disabled = true;

    addUserMessage(message);
    addTypingIndicator();

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: state.chatSessionId || null,
                message: message,
                cabinet: state.cabinet,
                skill_level: state.skillLevel,
                drink_type: state.drinkType
            })
        });

        const data = await response.json();
        removeTypingIndicator();

        state.chatSessionId = data.session_id;

        // Add Raja's response
        addBotMessage(data.content);

        // If Raja provided a special recipe (drink not in our database)
        if (data.special_recipe) {
            addSpecialRecipe(data.special_recipe);
        }
        // If Raja recommended a drink from our database, show a clickable link
        else if (data.recommended_drink_id) {
            const drinkName = data.drinks_mentioned && data.drinks_mentioned.length > 0
                ? data.drinks_mentioned[0].name
                : data.recommended_drink_id;
            addDrinkSuggestion(data.recommended_drink_id, drinkName);
        }

    } catch (error) {
        removeTypingIndicator();
        addBotMessage("Arrey, something went wrong! Let me try again, yaar.");
    }

    input.disabled = false;
    input.focus();
    showChatInput();
}

function addDrinkSuggestion(drinkId, drinkName) {
    const div = document.createElement('div');
    div.className = 'flex gap-2 sm:gap-3 animate-fade-in mt-2';
    div.innerHTML = `
        <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8"></div>
        <a href="/drink/${drinkId}" class="glass-card p-3 hover:bg-amber-600/10 transition-all flex items-center gap-3 group">
            <div class="w-10 h-10 rounded-full bg-amber-600/20 flex items-center justify-center">
                <span class="text-lg">&#127864;</span>
            </div>
            <div class="flex-1">
                <p class="text-amber-300 font-medium group-hover:text-amber-200">${drinkName}</p>
                <p class="text-stone-500 text-xs">Tap to view recipe</p>
            </div>
            <svg class="w-5 h-5 text-stone-500 group-hover:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </a>
    `;
    chatMessages.appendChild(div);
    scrollToBottom();
}

function addSpecialRecipe(recipe) {
    // This is Raja's special from memory - a drink not in our database
    const div = document.createElement('div');
    div.className = 'flex gap-2 sm:gap-3 animate-fade-in mt-3';

    const ingredientsList = recipe.ingredients.map(ing => `<li class="text-stone-300">${ing}</li>`).join('');
    const methodList = recipe.method.map((step, i) => `<li class="text-stone-300"><span class="text-amber-500 font-medium">${i + 1}.</span> ${step}</li>`).join('');

    div.innerHTML = `
        <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8"></div>
        <div class="glass-card p-4 flex-1 border border-amber-600/30">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">âœ¨</span>
                <div>
                    <p class="text-amber-300 font-bold text-lg">${recipe.name}</p>
                    <p class="text-amber-500/70 text-xs font-medium">Raja's Special from Memory</p>
                </div>
            </div>
            ${recipe.tagline ? `<p class="text-stone-400 text-sm italic mb-3">"${recipe.tagline}"</p>` : ''}

            <div class="space-y-3">
                <div>
                    <p class="text-amber-400 font-semibold text-sm mb-1">Ingredients</p>
                    <ul class="list-disc list-inside text-sm space-y-1">
                        ${ingredientsList}
                    </ul>
                </div>

                <div>
                    <p class="text-amber-400 font-semibold text-sm mb-1">Method</p>
                    <ol class="text-sm space-y-1">
                        ${methodList}
                    </ol>
                </div>

                ${recipe.glassware || recipe.garnish ? `
                <div class="flex gap-4 text-sm">
                    ${recipe.glassware ? `<div><span class="text-amber-400">Glass:</span> <span class="text-stone-300">${recipe.glassware}</span></div>` : ''}
                    ${recipe.garnish ? `<div><span class="text-amber-400">Garnish:</span> <span class="text-stone-300">${recipe.garnish}</span></div>` : ''}
                </div>
                ` : ''}

                ${recipe.tip ? `
                <div class="bg-amber-900/20 rounded-lg p-3 mt-2">
                    <p class="text-amber-200 text-sm"><span class="font-semibold">ðŸ’¡ Raja's Tip:</span> ${recipe.tip}</p>
                </div>
                ` : ''}
            </div>

            <p class="text-stone-500 text-xs mt-3 italic">This drink is not in our collection - recipe from Raja's memory</p>
        </div>
    `;
    chatMessages.appendChild(div);
    scrollToBottom();
}

// Step handlers
function showWelcome() {
    setTimeout(() => {
        addBotMessage("Arrey yaar, welcome! Raja here - learned from best in the business. âš ï¸ Quick note: I'm an AI, so verify recipes before mixing!");
        setTimeout(() => {
            if (state.cabinet.length > 0) {
                addBotMessage(`${state.cabinet.length} bottle${state.cabinet.length !== 1 ? 's' : ''} in your cabinet. So, what's the mood - ready to mix or just chatting?`);
                showQuickStartInput();
            } else {
                addBotMessage("Ask me anything about cocktails, or check the Cabinet tab to tell me what you have!");
                showChatInput();
            }
        }, 600);
    }, 300);
}

function showQuickStartInput() {
    state.step = 'quickstart';

    inputArea.innerHTML = `
        <div class="space-y-2">
            <div class="flex gap-2">
                <button id="use-cabinet-btn" class="btn glass-btn-primary flex-1 gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                    Mix with my ${state.cabinet.length} ingredient${state.cabinet.length !== 1 ? 's' : ''}
                </button>
                <button id="just-chat-btn" class="btn glass-btn-secondary flex-1 gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    Just chat
                </button>
            </div>
            <div class="flex gap-2">
                <button id="edit-cabinet-btn" class="btn btn-sm glass-btn-ghost flex-1 text-xs">
                    Edit Cabinet
                </button>
                <button id="start-fresh-btn" class="btn btn-sm glass-btn-ghost flex-1 text-xs">
                    Start Fresh
                </button>
            </div>
        </div>
    `;

    document.getElementById('use-cabinet-btn').addEventListener('click', () => {
        onCabinetDone();
    });

    document.getElementById('just-chat-btn').addEventListener('click', () => {
        addUserMessage("I just want to chat");
        setTimeout(() => {
            addBotMessage("Bilkul, yaar! Ask me anything - about cocktails, techniques, ingredients, or what drink would suit your mood. I'm all ears!");
            showChatInput();
        }, 400);
    });

    document.getElementById('edit-cabinet-btn').addEventListener('click', () => {
        if (window.TabManager) {
            window.TabManager.switchTo('cabinet');
        }
    });

    document.getElementById('start-fresh-btn').addEventListener('click', () => {
        state.cabinet = [];
        clearCabinet();
        updateCabinetCount();
        chatMessages.innerHTML = '';
        showWelcome();
    });
}

function showCabinetInput() {
    state.step = 'cabinet';

    // Chat input with option to go to cabinet
    inputArea.innerHTML = `
        <div class="space-y-2">
            <div class="flex gap-2">
                <input type="text" id="chat-input"
                       class="glass-input flex-1 text-sm py-2.5"
                       placeholder="Ask Raja anything about cocktails..."
                       autocomplete="off">
                <button id="chat-send-btn" class="btn glass-btn-primary px-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
            <button id="go-to-cabinet-btn" class="btn btn-sm glass-btn-ghost w-full gap-2 text-xs">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Or add ingredients to my cabinet
            </button>
        </div>
    `;

    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');

    sendBtn.addEventListener('click', sendChatMessage);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    });

    document.getElementById('go-to-cabinet-btn').addEventListener('click', () => {
        if (window.TabManager) {
            window.TabManager.switchTo('cabinet');
        }
    });

    input.focus();
}

function updateCabinetButton() {
    // Update cabinet count badge
    updateCabinetCount();
}

function onCabinetDone() {
    const names = state.cabinet.map(id => {
        for (const items of Object.values(ingredients)) {
            const found = items.find(i => i.id === id);
            if (found) return found.name;
        }
        return id.charAt(0).toUpperCase() + id.slice(1);
    });

    const displayText = names.length > 4
        ? `${names.slice(0, 4).join(', ')} +${names.length - 4} more`
        : names.join(', ');
    addUserMessage(displayText);

    setTimeout(() => {
        addBotMessage("Nice! What's the vibe tonight?");
        showMoodInput();
    }, 400);
}

function showMoodInput() {
    state.step = 'mood';

    const moods = [
        { text: 'Relaxing', emoji: '' },
        { text: 'Celebrating', emoji: '' },
        { text: 'Date night', emoji: '' },
        { text: 'Cozy', emoji: '' },
        { text: 'Adventurous', emoji: '' }
    ];

    inputArea.innerHTML = `
        <div class="space-y-2">
            <div class="flex flex-wrap gap-1.5">
                ${moods.map(m => `
                    <button type="button" class="mood-chip glass-chip px-2.5 py-1.5 rounded-lg text-xs hover:bg-amber-600/20 hover:border-amber-500/40 text-stone-300 transition-all">
                        ${m.text}
                    </button>
                `).join('')}
            </div>
            <div class="flex gap-2">
                <input type="text" id="mood-input"
                       class="glass-input flex-1 text-sm py-2"
                       placeholder="Or describe it...">
                <button id="mood-done-btn" class="btn btn-sm glass-btn-primary px-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;

    document.querySelectorAll('.mood-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.getElementById('mood-input').value = chip.textContent.trim();
            document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active', 'bg-amber-600/30', 'border-amber-500/50'));
            chip.classList.add('active', 'bg-amber-600/30', 'border-amber-500/50');
        });
    });

    const moodInput = document.getElementById('mood-input');
    const moodBtn = document.getElementById('mood-done-btn');
    moodBtn.addEventListener('click', onMoodDone);
    moodInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') onMoodDone();
    });
}

function onMoodDone() {
    state.mood = document.getElementById('mood-input').value || 'surprise me';
    addUserMessage(state.mood);

    setTimeout(() => {
        addBotMessage("How fancy should we get?");
        showSkillInput();
    }, 400);
}

function showSkillInput() {
    state.step = 'skill';

    inputArea.innerHTML = `
        <div class="space-y-3">
            <div class="grid grid-cols-3 gap-2">
                <button type="button" data-skill="beginner" class="skill-btn glass-card p-2.5 sm:p-3 text-center hover:bg-amber-600/10 transition-all">
                    <div class="text-xl sm:text-2xl mb-0.5">Simple</div>
                    <div class="text-stone-200 font-medium text-xs sm:text-sm">Quick</div>
                </button>
                <button type="button" data-skill="intermediate" class="skill-btn glass-card p-2.5 sm:p-3 text-center hover:bg-amber-600/10 transition-all border-amber-500/30">
                    <div class="text-xl sm:text-2xl mb-0.5">Classic</div>
                    <div class="text-stone-200 font-medium text-xs sm:text-sm">Balanced</div>
                </button>
                <button type="button" data-skill="adventurous" class="skill-btn glass-card p-2.5 sm:p-3 text-center hover:bg-amber-600/10 transition-all">
                    <div class="text-xl sm:text-2xl mb-0.5">Fancy</div>
                    <div class="text-stone-200 font-medium text-xs sm:text-sm">Creative</div>
                </button>
            </div>

            <div class="flex gap-1.5">
                <label class="drink-type-label glass-chip flex-1 text-center py-1.5 rounded-lg cursor-pointer transition-all hover:bg-amber-600/20 text-xs">
                    <input type="radio" name="drinkType" value="cocktail" class="hidden">
                    <span class="text-stone-300">Cocktail</span>
                </label>
                <label class="drink-type-label glass-chip flex-1 text-center py-1.5 rounded-lg cursor-pointer transition-all hover:bg-amber-600/20 text-xs">
                    <input type="radio" name="drinkType" value="mocktail" class="hidden">
                    <span class="text-stone-300">Mocktail</span>
                </label>
                <label class="drink-type-label glass-chip flex-1 text-center py-1.5 rounded-lg cursor-pointer transition-all bg-amber-600/20 border-amber-500/40 text-xs">
                    <input type="radio" name="drinkType" value="both" class="hidden" checked>
                    <span class="text-amber-200">Either</span>
                </label>
            </div>
        </div>
    `;

    document.querySelectorAll('.skill-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.skill-btn').forEach(b => b.classList.remove('border-amber-500/50', 'bg-amber-600/20'));
            btn.classList.add('border-amber-500/50', 'bg-amber-600/20');
            state.skillLevel = btn.dataset.skill;
            onSkillDone();
        });
    });

    document.querySelectorAll('.drink-type-label').forEach(label => {
        label.addEventListener('click', () => {
            document.querySelectorAll('.drink-type-label').forEach(l => {
                l.classList.remove('bg-amber-600/20', 'border-amber-500/40');
                l.querySelector('span').classList.remove('text-amber-200');
                l.querySelector('span').classList.add('text-stone-300');
            });
            label.classList.add('bg-amber-600/20', 'border-amber-500/40');
            label.querySelector('span').classList.remove('text-stone-300');
            label.querySelector('span').classList.add('text-amber-200');
            state.drinkType = label.querySelector('input').value;
        });
    });
}

function onSkillDone() {
    const skillLabels = { beginner: 'Simple', intermediate: 'Classic', adventurous: 'Fancy' };
    addUserMessage(skillLabels[state.skillLevel]);

    setTimeout(() => {
        addBotMessage("Mixing something special...");
        addTypingIndicator();
        showLoadingInput();
        startFlow();
    }, 400);
}

function showLoadingInput() {
    // Pick a random starting fact
    let factIndex = Math.floor(Math.random() * mixologyFacts.length);

    inputArea.innerHTML = `
        <div class="text-center py-3 space-y-2">
            <div class="text-stone-400 text-xs uppercase tracking-wider animate-pulse">Crafting your recommendation</div>
            <div id="mixology-fact" class="text-amber-300/80 text-sm px-4 transition-opacity duration-300">
                ${mixologyFacts[factIndex]}
            </div>
        </div>
    `;

    // Rotate facts every 3 seconds
    factInterval = setInterval(() => {
        factIndex = (factIndex + 1) % mixologyFacts.length;
        const factEl = document.getElementById('mixology-fact');
        if (factEl) {
            factEl.style.opacity = '0';
            setTimeout(() => {
                factEl.textContent = mixologyFacts[factIndex];
                factEl.style.opacity = '1';
            }, 300);
        }
    }, 3000);
}

function stopFactRotation() {
    if (factInterval) {
        clearInterval(factInterval);
        factInterval = null;
    }
}

async function startFlow() {
    try {
        const response = await fetch('/api/flow', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'START',
                cabinet: state.cabinet,
                mood: state.mood,
                skill_level: state.skillLevel,
                drink_type: state.drinkType
            })
        });

        const data = await response.json();
        stopFactRotation();
        removeTypingIndicator();

        if (data.success && data.recipe) {
            state.sessionId = data.session_id;
            showRecipe(data);
        } else {
            addBotMessage(data.error || "Couldn't find a match. Try more ingredients!");
            showRetryInput();
        }
    } catch (error) {
        stopFactRotation();
        removeTypingIndicator();
        addBotMessage("Something went wrong. Let's try again!");
        showRetryInput();
    }
}

function showRecipe(data) {
    const template = document.getElementById('recipe-card-template');
    const clone = template.content.cloneNode(true);

    const recipe = data.recipe;
    clone.querySelector('#recipe-name').textContent = recipe.name || 'Your Drink';
    clone.querySelector('#recipe-tagline').textContent = recipe.tagline || '';

    const score = data.alternatives?.[0]?.mood_score || Math.floor(Math.random() * 15) + 85;
    clone.querySelector('#recipe-score').textContent = `${score}%`;

    if (recipe.why) {
        clone.querySelector('#recipe-why').textContent = recipe.why;
    } else {
        clone.querySelector('#recipe-why-section').remove();
    }

    const ingredientsList = clone.querySelector('#recipe-ingredients');
    (recipe.ingredients || []).forEach(ing => {
        const li = document.createElement('li');
        li.className = 'text-stone-300 flex gap-2';
        li.innerHTML = `<span class="text-amber-400 w-14 flex-shrink-0">${ing.amount || ''}</span><span>${ing.name || ing}</span>`;
        ingredientsList.appendChild(li);
    });

    const stepsList = clone.querySelector('#recipe-steps');
    (recipe.method || recipe.steps || []).forEach((step, index) => {
        const li = document.createElement('li');
        li.className = 'flex gap-2 text-stone-300';
        li.innerHTML = `
            <span class="flex-shrink-0 w-5 h-5 rounded-full bg-amber-600/30 text-amber-300 flex items-center justify-center text-xs">${index + 1}</span>
            <span>${step.instruction || step}</span>
        `;
        stepsList.appendChild(li);
    });

    let hasDetails = false;
    if (recipe.glassware) {
        clone.querySelector('#recipe-glass').textContent = recipe.glassware;
        clone.querySelector('#recipe-glass-section').classList.remove('hidden');
        hasDetails = true;
    }
    if (recipe.garnish) {
        clone.querySelector('#recipe-garnish').textContent = recipe.garnish;
        clone.querySelector('#recipe-garnish-section').classList.remove('hidden');
        hasDetails = true;
    }
    if (!hasDetails) {
        clone.querySelector('#recipe-details-section').remove();
    }

    if (data.next_bottle) {
        clone.querySelector('#bottle-name').textContent = data.next_bottle.ingredient;
        clone.querySelector('#bottle-unlocks').textContent = `+${data.next_bottle.unlocks}`;
        clone.querySelector('#bottle-rec').classList.remove('hidden');
    }

    // Get button references from the clone BEFORE appending to DOM
    const madeItBtn = clone.querySelector('#made-it-btn');
    const anotherBtn = clone.querySelector('#another-btn');

    chatMessages.appendChild(clone);

    // Initialize collapsibles for the new recipe card
    setTimeout(() => {
        initCollapsibles(chatMessages);
        // Use the button references we captured from the clone
        madeItBtn.addEventListener('click', onMadeIt);
        anotherBtn.addEventListener('click', onAnother);
    }, 50);

    scrollToBottom();
    showRecipeInput();
}

function showRecipeInput() {
    inputArea.innerHTML = `
        <div class="text-center text-stone-500 text-xs py-1">
            Tap buttons above to continue
        </div>
    `;
}

function showRetryInput() {
    inputArea.innerHTML = `
        <button id="retry-btn" class="btn btn-sm glass-btn-primary w-full">
            Try Again
        </button>
    `;
    document.getElementById('retry-btn').addEventListener('click', resetChat);
}

async function onMadeIt() {
    if (!state.sessionId) return;

    const drinkId = document.querySelector('#recipe-name')?.textContent?.toLowerCase().replace(/\s+/g, '-') || 'drink';
    addUserMessage("Made it!");

    try {
        await fetch('/api/flow', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'MADE',
                session_id: state.sessionId,
                drink_id: drinkId
            })
        });

        addBotMessage("Cheers! Enjoy!");
        showEndInput();
    } catch (error) {
        addBotMessage("Cheers! Enjoy!");
        showEndInput();
    }
}

async function onAnother() {
    if (!state.sessionId) return;

    addUserMessage("Show me another");
    addTypingIndicator();
    showLoadingInput();

    try {
        const response = await fetch('/api/flow', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'ANOTHER',
                session_id: state.sessionId
            })
        });

        const data = await response.json();
        stopFactRotation();
        removeTypingIndicator();

        if (data.success && data.recipe) {
            addBotMessage("How about this one?");
            showRecipe(data);
        } else {
            addBotMessage(data.error || "That's all I've got! Try adding more ingredients.");
            showEndInput();
        }
    } catch (error) {
        stopFactRotation();
        removeTypingIndicator();
        addBotMessage("Couldn't fetch another. Try refreshing!");
        showRetryInput();
    }
}

function showEndInput() {
    inputArea.innerHTML = `
        <div class="space-y-2">
            <button id="start-over-btn" class="btn btn-sm glass-btn-secondary w-full">
                Start Fresh
            </button>
            <a href="/browse" class="block text-center text-stone-500 hover:text-amber-400 text-xs transition-colors py-1">
                Or browse our full collection
            </a>
        </div>
    `;
    document.getElementById('start-over-btn').addEventListener('click', resetChat);
}

// Initialize
init();
</script>
<!-- All styles consolidated in glassmorphic.css -->
{% endblock %}
